<head>
  <link href = "css/index.css" rel = "stylesheet" type = "text/css">
<title>Ballings</title>
<meta name="author" content="John Day">
<script src="js/lib/matter.js"></script>
<script src="js/lemming.js"></script>
<script src="js/alias.js"></script>
<script src="js/grid.js"></script>
<script src="js/lemming.js"></script>

<script src="js/index.js"></script>
<script src="js/p5/p5.min.js"></script>


</head>
<body>

  <div id="score">0</div>

  <script>

  function setup() {
    createCanvas(640, 480);
  }

    // create an engine
    var engine = Engine.create();
    var exitArray = []

    // // create a renderer
    var render = Render.create({
        element: document.body,
        engine: engine,
        options: {
            width: canvasSize.width,
          height: canvasSize.height,
          wireframes: false
      }
    });


    var mouse = Mouse.create(render.canvas);

    var mouseConstraint = MouseConstraint.create(engine, {mouse: mouse, constraint: {stiffness: 0.2}});
    var mouseIsDown = false;


    World.add(engine.world, [mouseConstraint]);

    Events.on(engine, 'mousedown', function(event) {
    var mousePosition = event.mouse.position;
    mouseIsDown = true;
    console.log(mousePosition);
    });

    // Events.on(engine, 'mousedown', function(event) {
    //   var mousePosition = event.mouse.position;
    //     lemming.shape.force = {
    //       x: 0.001,
    //       y: -0.01
    //       };
    //     });


    // MouseConstraint.update = function(mouseConstraint, bodies) {
    // var mouse = mouseConstraint.mouse,
    // constraints = [];
    // constraint = mouseConstraint.constraints[0];
    //
    //     if (mouse.button === 0 || mouse.button === 2) {
    //         if (!constraint.bodyB) {
    //             for (var i = 0; i < bodies.length; i++) {
    //                 var body = bodies[i];
    //                 if (Bounds.contains(body.bounds, mouse.position)  && Vertices.contains(body.vertices, mouse.position)) {
    //                     constraint.pointA = mouse.position;
    //                     constraint.bodyB = body;
    //                     constraint.pointB = { x: mouse.position.x - body.position.x, y: mouse.position.y - body.position.y };
    //                     constraint.angleB = body.angle;
    //                     Sleeping.set(body, false);
    //  Events.trigger(engine, 'bodytouched', lemming.shape);
    //         }
    //       }
    //     }
    // } else {
    // constraint.bodyB = null;
    // constraint.pointB = null;
    // }
    //
    //     if (constraint.bodyB) {
    //         Sleeping.set(constraint.bodyB, false);
    //         constraint.pointA = mouse.position;
    //     }
    // };


    layerNodes = 40;
    layers = 20;
    grid = new Grid(layerNodes, layers);


    grid.generateBucket();
    grid.generateBlock(3, 7, 15, 1)
    grid.generateBlock(17, 7, 1, 10)
    grid.entranceBlock(2, 10);
    grid.exitBlock(37, 1);

    var defaultCategory = 0x0001;
    var lemmingCategory = 0x0002;
    var lemmings = [];
    for (var i = 0; i < 10; i++) {
      setTimeout(function(){
        lemmings.push(new Lemming(grid.spawn));
        console.log(lemmings);
      }, i * 1000);
    };


    Events.on(engine, 'collisionStart', function(event){

      for (var i = 0; i < event.pairs.length; i++) {
        var lemming = null;
        if (event.pairs[i].bodyA.label === "Circle Body"){
          lemming = event.pairs[i].bodyA;
        } else if (event.pairs[i].bodyB.label === "Circle Body"){
          lemming = event.pairs[i].bodyB;
        }
        if (lemming != null){

          if (lemming.position.x >= grid.exit.x) {
            exitArray.push(1)
            World.remove(engine.world, [lemming])
            document.getElementById("score").innerHTML = exitArray.length
            return
          }


          if (lemming.velocity.x >= 0) {
            Matter.Body.setVelocity(lemming, { x: 3, y: -1 })
          }
          else if (lemming.velocity.x < 0) {
            Matter.Body.setVelocity(lemming, { x: -3, y: -1})
          };
        };
      };
    });

    Events.on(mouseConstraint, "startdrag", function(event) {
      console.log(mouse.position.x);
      console.log(event.body.position.x);

      bodies = Composite.allBodies(engine.world)
      var endPoint = {x: event.body.position.x, y: event.body.position.y-20}
      var diggings = Query.point(bodies, endPoint);
      console.log(diggings);
      if(diggings.length > 0) {
        World.remove(engine.world, [diggings[0]], true)
      }
    })




    run();
  </script>
</body>
</html>
